library(ggplot2)
library(broom)
library(eurostat)
library(readxl)
library(lmtest)     # For bptest og coeftest
library(car)        # For ncvTest (score-test)
library(tibble)     # For å lage tabeller
library(fixest)
library(plm)
library(modelsummary)
# Laster ned utdanningsdatasettet fra Eurostat
utdanning <- get_eurostat("edat_lfse_04", time_format = "num")
# Filtrerer utdanningsdata for 2017 og grupperer regionene etter lav, middels og høy utdanning
utdanning_2017 <- utdanning %>%
filter(
TIME_PERIOD == 2017,
sex == "T",            # Begge kjønn
age == "Y25-64",       # Aldersgruppen 25–64 år
unit == "PC",          # Enhet: prosent av befolkningen
nchar(geo) == 4,       # Beholder kun NUTS2-nivå (fire tegn)
substr(geo, 1, 2) %in% c("BE","NL","BG","NO"),
isced11 != "ED3-8"
)%>%
mutate(edu_group = case_when(
isced11 == "ED0-2" ~ "Low",
isced11 %in% c("ED3_4", "ED3_4GEN", "ED3_4VOC") ~ "Medium",
isced11 == "ED5-8" ~ "High",
TRUE ~ NA_character_
)) # lager tre utdanningsnivå (lav, middels, høy)
# Gjør utdanningsdata om til bredt format med tre kolonner for lav, middels og høy utdanning per region
utdanning_2017_trenivå <- utdanning_2017 %>%
select(geo, edu_group, values) %>%
pivot_wider(names_from = edu_group, values_from = values) %>%
rename(
`Lav_utdanning`     = Low,
`Middels_utdanning` = Medium,
`Høy_utdanning`     = High
)
# leser excel data_2017_b som brukt i assignment 2 del b
data_2017_b <- read_excel("/Users/liang/Desktop/msb104/msb104_a3/data_2017_b.xlsx", sheet = "data_2017_b")
# leser excel data_2017_b som brukt i assignment 2 del b
data_2017_b <- read_excel("../data/data_2017_b.xlsx", sheet = "data_2017_b")
# leser excel data_2017_b som brukt i assignment 2 del b
data_2017_b <- read_excel("../data/data_2017_b.xlsx", sheet = "data_2017_b")
# leser excel data_2017_b som brukt i assignment 2 del b
data_2017_b <- read_excel("../data_2017_b.xlsx", sheet = "data_2017_b")
# leser excel data_2017_b som brukt i assignment 2 del b
data_2017_b <- read_excel("./data_2017_b.xlsx", sheet = "data_2017_b")
# Slå sammen med hoveddatasettet (NUTS2 <-> geo)
data_2017 <- data_2017_b %>%
left_join(utdanning_2017_trenivå, by = c("NUTS2" = "geo")) %>%
select(-utdanning_hoy)
# Low education subset
model_lav  <- lm(Gini_weighted ~ change_GDPC_pct + vei_tetthet + andelen_over65 + Lav_utdanning, data = data_2017)
summary(model_lav)
# Medium education subset
model_middels  <- lm(Gini_weighted ~ change_GDPC_pct + vei_tetthet + andelen_over65 + Middels_utdanning, data = data_2017)
summary(model_middels)
# High education subset
model_hoy  <- lm(Gini_weighted ~ change_GDPC_pct + vei_tetthet + andelen_over65 + Høy_utdanning, data = data_2017)
summary(model_hoy)
#| label: tbl-subset
#| tbl-cap: "Resultater av delmengderegresjon på tvers av utdanningsgrupper"
modelsummary(
list(
"Low education regions"    = model_lav,
"Medium education regions" = model_middels,
"High education regions"   = model_hoy
),
stars = TRUE,
statistic = "({statistic})",
fmt = 5,
output = "markdown"
)
# Lager et nytt datasett for visualisering av modellene
visualisering_data <- data.frame(
change_GDPC_pct = seq(min(data_2017$change_GDPC_pct, na.rm = TRUE),
max(data_2017$change_GDPC_pct, na.rm = TRUE),
length.out = 100), # Oppretter 100 jevnt fordelte verdier for økonomisk vekst (change_GDPC_pct)
vei_tetthet = mean(data_2017$vei_tetthet, na.rm = TRUE),
andelen_over65 = mean(data_2017$andelen_over65, na.rm = TRUE),
Høy_utdanning = mean(data_2017$`Høy_utdanning`, na.rm = TRUE)) # Holder de andre forklaringsvariablene konstante ved å bruke gjennomsnittsverdier
# Beregner predikerte Gini-verdier fra den log-lineære modellen
visualisering_data$pred_log  <- predict(model_log,  newdata = visualisering_data)
# Beregner predikerte Gini-verdier fra den kvadratiske modellen
visualisering_data$pred_kvad <- predict(model_kvad, newdata = visualisering_data)
# Pakker
library(dplyr)
library(dineq)
library(tidyr)
library(ggplot2)
library(broom)
library(eurostat)
library(readxl)
library(lmtest)     # For bptest og coeftest
library(car)        # For ncvTest (score-test)
library(tibble)     # For å lage tabeller
library(fixest)
library(plm)
library(modelsummary)
# Laster ned utdanningsdatasettet fra Eurostat
utdanning <- get_eurostat("edat_lfse_04", time_format = "num")
# Filtrerer utdanningsdata for 2017 og grupperer regionene etter lav, middels og høy utdanning
utdanning_2017 <- utdanning %>%
filter(
TIME_PERIOD == 2017,
sex == "T",            # Begge kjønn
age == "Y25-64",       # Aldersgruppen 25–64 år
unit == "PC",          # Enhet: prosent av befolkningen
nchar(geo) == 4,       # Beholder kun NUTS2-nivå (fire tegn)
substr(geo, 1, 2) %in% c("BE","NL","BG","NO"),
isced11 != "ED3-8"
)%>%
mutate(edu_group = case_when(
isced11 == "ED0-2" ~ "Low",
isced11 %in% c("ED3_4", "ED3_4GEN", "ED3_4VOC") ~ "Medium",
isced11 == "ED5-8" ~ "High",
TRUE ~ NA_character_
)) # lager tre utdanningsnivå (lav, middels, høy)
# Gjør utdanningsdata om til bredt format med tre kolonner for lav, middels og høy utdanning per region
utdanning_2017_trenivå <- utdanning_2017 %>%
select(geo, edu_group, values) %>%
pivot_wider(names_from = edu_group, values_from = values) %>%
rename(
`Lav_utdanning`     = Low,
`Middels_utdanning` = Medium,
`Høy_utdanning`     = High
)
# leser excel data_2017_b som brukt i assignment 2 del b
data_2017_b <- read_excel("./data_2017_b.xlsx", sheet = "data_2017_b")
# Slå sammen med hoveddatasettet (NUTS2 <-> geo)
data_2017 <- data_2017_b %>%
left_join(utdanning_2017_trenivå, by = c("NUTS2" = "geo")) %>%
select(-utdanning_hoy)
# Low education subset
model_lav  <- lm(Gini_weighted ~ change_GDPC_pct + vei_tetthet + andelen_over65 + Lav_utdanning, data = data_2017)
summary(model_lav)
# Medium education subset
model_middels  <- lm(Gini_weighted ~ change_GDPC_pct + vei_tetthet + andelen_over65 + Middels_utdanning, data = data_2017)
summary(model_middels)
# High education subset
model_hoy  <- lm(Gini_weighted ~ change_GDPC_pct + vei_tetthet + andelen_over65 + Høy_utdanning, data = data_2017)
summary(model_hoy)
#| label: tbl-subset
#| tbl-cap: "Resultater av delmengderegresjon på tvers av utdanningsgrupper"
modelsummary(
list(
"Low education regions"    = model_lav,
"Medium education regions" = model_middels,
"High education regions"   = model_hoy
),
stars = TRUE,
statistic = "({statistic})",
fmt = 5,
output = "markdown"
)
# Log-lineær modell
model_log <- lm(Gini_weighted ~ log(change_GDPC_pct + 1) + vei_tetthet + andelen_over65 + `Høy_utdanning`, data = data_2017)
summary(model_log)
# Kvadratisk modell
model_kvad <- lm(Gini_weighted ~ change_GDPC_pct + I(change_GDPC_pct^2) + vei_tetthet + andelen_over65 + `Høy_utdanning`, data = data_2017)
summary(model_kvad)
# Kubisk modell
model_kub <- lm(Gini_weighted ~ change_GDPC_pct + I(change_GDPC_pct^2) + I(change_GDPC_pct^3) + vei_tetthet + andelen_over65 + `Høy_utdanning`, data = data_2017)
summary(model_kub)
#| label: tbl-funksjonsformer
#| tbl-cap: "logaritmiske, kvadratiske, kubiske"
modelsummary(
list(
"Log-lineær modell" = model_log,
"Kvadratisk modell" = model_kvad,
"Kubisk modell"     = model_kub
),
stars = TRUE,
statistic = "({statistic})",   # viser t-verdier i parentes
fmt = 5,
output = "markdown"
)
# Lager et nytt datasett for visualisering av modellene
visualisering_data <- data.frame(
change_GDPC_pct = seq(min(data_2017$change_GDPC_pct, na.rm = TRUE),
max(data_2017$change_GDPC_pct, na.rm = TRUE),
length.out = 100), # Oppretter 100 jevnt fordelte verdier for økonomisk vekst (change_GDPC_pct)
vei_tetthet = mean(data_2017$vei_tetthet, na.rm = TRUE),
andelen_over65 = mean(data_2017$andelen_over65, na.rm = TRUE),
Høy_utdanning = mean(data_2017$`Høy_utdanning`, na.rm = TRUE)) # Holder de andre forklaringsvariablene konstante ved å bruke gjennomsnittsverdier
# Beregner predikerte Gini-verdier fra den log-lineære modellen
visualisering_data$pred_log  <- predict(model_log,  newdata = visualisering_data)
# Beregner predikerte Gini-verdier fra den kvadratiske modellen
visualisering_data$pred_kvad <- predict(model_kvad, newdata = visualisering_data)
#| label: fig-log-kvadratisk
#| fig-cap: "Visualisering av log-lineær og kvadratisk modell for sammenhengen mellom økonomisk utvikling og inntektsulikhet"
visualisering <- data_2017 %>%
ggplot(aes(x = change_GDPC_pct, y = Gini_weighted)) +
geom_point(alpha = 0.6, color = "grey40") +
geom_line(data = visualisering_data, aes(y = pred_log, color = "Log-lineær modell"), size = 1.2) +
geom_line(data = visualisering_data, aes(y = pred_kvad, color = "Kvadratisk modell"), size = 1.2, linetype = "dashed") +
scale_color_manual(values = c("Log-lineær modell" = "blue", "Kvadratisk modell" = "red")) +
labs(
title = "Sammenheng mellom økonomisk utvikling og inntektsulikhet",
subtitle = "Sammenligning av log-lineær og kvadratisk modell",
x = "Endring i BNP per innbygger (%)",
y = "Gini-koeffisient",
color = "Modell"
) +
theme_minimal(base_size = 13)  +
theme(
legend.text = element_text(size = 5),
legend.title = element_text(size = 6)
)
visualisering
#| label: fig-log-kvadratisk
#| fig-cap: "Visualisering av log-lineær og kvadratisk modell for sammenhengen mellom økonomisk utvikling og inntektsulikhet"
visualisering <- data_2017 %>%
ggplot(aes(x = change_GDPC_pct, y = Gini_weighted)) +
geom_point(alpha = 0.6, color = "grey40") +
geom_line(
data = visualisering_data,
mapping = aes(y = pred_log, color = "Log-lineær modell"),
linewidth = 1.2
) +
geom_line(
data = visualisering_data,
mapping = aes(y = pred_kvad, color = "Kvadratisk modell"),
linewidth = 1.2,
linetype = "dashed"
) +
scale_color_manual(values = c("Log-lineær modell" = "blue", "Kvadratisk modell" = "red")) +
labs(
title = "Sammenheng mellom økonomisk utvikling og inntektsulikhet",
subtitle = "Sammenligning av log-lineær og kvadratisk modell",
x = "Endring i BNP per innbygger (%)",
y = "Gini-koeffisient",
color = "Modell"
) +
theme_minimal(base_size = 13)  +
theme(
legend.text = element_text(size = 5),
legend.title = element_text(size = 6)
)
visualisering
# Breusch–Pagan-test
bp_log  <- bptest(model_log)
bp_kvad <- bptest(model_kvad)
bp_kub  <- bptest(model_kub)
# White-test (BP på predikerte verdier og deres kvadrat)
wt_log  <- bptest(model_log,  ~ fitted(model_log)  + I(fitted(model_log)^2))
wt_kvad <- bptest(model_kvad, ~ fitted(model_kvad) + I(fitted(model_kvad)^2))
wt_kub  <- bptest(model_kub,  ~ fitted(model_kub)  + I(fitted(model_kub)^2))
# Score-test (car::ncvTest)
sc_log  <- ncvTest(model_log)
sc_kvad <- ncvTest(model_kvad)
sc_kub  <- ncvTest(model_kub)
#| label: tbl-heteroskedastisitet
#| tbl-cap: "Resultater fra Breusch–Pagan-, White- og Score-testene for de tre modellene"
# Samler testresultatene i en tabell
hetero_test <- tibble(
Modell  = c("Log-lineær", "Kvadratisk", "Kubisk"),
BP_p    = c(bp_log$p.value,  bp_kvad$p.value,  bp_kub$p.value),
White_p = c(wt_log$p.value,  wt_kvad$p.value,  wt_kub$p.value),
Score_p = c(sc_log$p,        sc_kvad$p,        sc_kub$p)
)
hetero_test
#| label: tbl-heteroskedastisitet
#| tbl-cap: "Resultater fra Breusch–Pagan-, White- og Score-testene for de tre modellene"
# Samler testresultatene i en tabell
hetero_test <- tibble(
Modell  = c("Log-lineær", "Kvadratisk", "Kubisk"),
BP_p    = c(bp_log$p.value,  bp_kvad$p.value,  bp_kub$p.value),
White_p = c(wt_log$p.value,  wt_kvad$p.value,  wt_kub$p.value),
Score_p = c(sc_log$p,        sc_kvad$p,        sc_kub$p)
)
hetero_test |>
flextable()
#| label: tbl-heteroskedastisitet
#| tbl-cap: "Resultater fra Breusch–Pagan-, White- og Score-testene for de tre modellene"
# Samler testresultatene i en tabell
hetero_test <- tibble(
Modell  = c("Log-lineær", "Kvadratisk", "Kubisk"),
BP_p    = c(bp_log$p.value,  bp_kvad$p.value,  bp_kub$p.value),
White_p = c(wt_log$p.value,  wt_kvad$p.value,  wt_kub$p.value),
Score_p = c(sc_log$p,        sc_kvad$p,        sc_kub$p)
)
hetero_test |>
flextable()
#| label: setup
# Pakker
library(dplyr)
library(dineq)
library(tidyr)
library(ggplot2)
library(broom)
library(eurostat)
library(readxl)
library(lmtest)     # For bptest og coeftest
library(car)        # For ncvTest (score-test)
library(tibble)     # For å lage tabeller
library(fixest)
library(plm)
library(modelsummary)
library(flextable)
#| label: tbl-heteroskedastisitet
#| tbl-cap: "Resultater fra Breusch–Pagan-, White- og Score-testene for de tre modellene"
# Samler testresultatene i en tabell
hetero_test <- tibble(
Modell  = c("Log-lineær", "Kvadratisk", "Kubisk"),
BP_p    = c(bp_log$p.value,  bp_kvad$p.value,  bp_kub$p.value),
White_p = c(wt_log$p.value,  wt_kvad$p.value,  wt_kub$p.value),
Score_p = c(sc_log$p,        sc_kvad$p,        sc_kub$p)
)
hetero_test |>
flextable()
# Laster ned og filtrerer datasett for perioden 2008–2022
# Nedlasting av BNP 2008–2022
gdp_panel <- get_eurostat("nama_10r_3gdp", time_format="num") %>%
filter(
unit == "MIO_EUR",
TIME_PERIOD %in% 2008:2022,
nchar(geo) == 5,
substr(geo,1,2) %in% c("BE","NL","BG","NO")
) %>%
select(geo, TIME_PERIOD, values_gdp = values)
# Nedlasting av befolkning 2008–2022
pop_panel <- get_eurostat("demo_r_pjanaggr3", time_format="num") %>%
filter(
sex == "T",
age == "TOTAL",
TIME_PERIOD %in% 2008:2022,
nchar(geo) == 5,
substr(geo,1,2) %in% c("BE","NL","BG","NO")
) %>%
select(geo, TIME_PERIOD, values_pop = values)
# Slå sammen
gdp_pop_panel <- gdp_panel %>%
left_join(pop_panel, by = c("geo", "TIME_PERIOD")) %>%
mutate(
NUTS2 = substr(geo, 1, 4),
GDPC  = values_gdp * 1e6 / values_pop
) %>%
filter(values_pop > 0, is.finite(GDPC)) %>%
# beregnes årlig vekstrate i GDPC på NUTS2-nivå
group_by(NUTS2) %>%
arrange(TIME_PERIOD, .by_group = TRUE) %>%
mutate(change_GDPC_pct = (GDPC / lag(GDPC) - 1) * 100) %>%
ungroup() %>%
# beregnes Gini på (NUTS2, TIME_PERIOD)-nivå, og oppsummeres direkte
group_by(NUTS2, TIME_PERIOD) %>%
mutate(
Gini_weighted = if (n() >= 2)
as.numeric(gini.wtd(GDPC, weights = values_pop))
else
NA_real_
) %>%
summarise(
GDPC           = sum(values_gdp * 1e6) / sum(values_pop),  # Befolkningsvektet GDPC for NUTS2
change_GDPC_pct = mean(change_GDPC_pct, na.rm = TRUE),      # Skal være identisk innen samme NUTS2-år
Gini_weighted   = mean(Gini_weighted, na.rm = TRUE),        # Beholder NA, filtrerer ikke bort
.groups = "drop"
)
# Laster ned og filtrerer datasett for perioden 2008–2022
# Nedlasting av BNP 2008–2022
gdp_panel <- get_eurostat("nama_10r_3gdp", time_format="num") %>%
filter(
unit == "MIO_EUR",
TIME_PERIOD %in% 2008:2022,
nchar(geo) == 5,
substr(geo,1,2) %in% c("BE","NL","BG","NO")
) %>%
select(geo, TIME_PERIOD, values_gdp = values)
# Nedlasting av befolkning 2008–2022
pop_panel <- get_eurostat("demo_r_pjanaggr3", time_format="num") %>%
filter(
sex == "T",
age == "TOTAL",
TIME_PERIOD %in% 2008:2022,
nchar(geo) == 5,
substr(geo,1,2) %in% c("BE","NL","BG","NO")
) %>%
select(geo, TIME_PERIOD, values_pop = values)
# Slå sammen
gdp_pop_panel <- gdp_panel %>%
left_join(pop_panel, by = c("geo", "TIME_PERIOD")) %>%
mutate(
NUTS2 = substr(geo, 1, 4),
GDPC  = values_gdp * 1e6 / values_pop
) %>%
filter(values_pop > 0, is.finite(GDPC)) %>%
# beregnes årlig vekstrate i GDPC på NUTS2-nivå
group_by(NUTS2) %>%
arrange(TIME_PERIOD, .by_group = TRUE) %>%
mutate(change_GDPC_pct = (GDPC / lag(GDPC) - 1) * 100) %>%
ungroup() %>%
# beregnes Gini på (NUTS2, TIME_PERIOD)-nivå, og oppsummeres direkte
group_by(NUTS2, TIME_PERIOD) %>%
mutate(
Gini_weighted = if (n() >= 2)
as.numeric(gini.wtd(GDPC, weights = values_pop))
else
NA_real_
) %>%
summarise(
GDPC           = sum(values_gdp * 1e6) / sum(values_pop),  # Befolkningsvektet GDPC for NUTS2
change_GDPC_pct = mean(change_GDPC_pct, na.rm = TRUE),      # Skal være identisk innen samme NUTS2-år
Gini_weighted   = mean(Gini_weighted, na.rm = TRUE),        # Beholder NA, filtrerer ikke bort
.groups = "drop"
)
# høy utdanning 2008–2022
edu_panel <- utdanning %>%
filter(
TIME_PERIOD %in% 2008:2022,
sex=="T", age=="Y25-64", unit=="PC",
isced11=="ED5-8",
nchar(geo)==4,
substr(geo,1,2) %in% c("BE","NL","BG","NO")
) %>%
select(NUTS2 = geo, TIME_PERIOD, Høy_utdanning = values)
# population (andel over 65 år) 2008–2022
pop_panel <- get_eurostat("demo_r_pjangrp3", time_format="num") %>%
filter(
TIME_PERIOD %in% 2008:2022,
sex=="T",
nchar(geo)==4,
substr(geo,1,2) %in% c("BE","NL","BG","NO")
) %>%
group_by(geo, TIME_PERIOD) %>%
summarise(
pop_over65 = sum(values[age %in% c("Y65-69","Y70-74","Y75-79","Y80-84","Y85-89","Y_GE85")]),
pop_total  = sum(values[age=="TOTAL"]),
andelen_over65 = pop_over65/pop_total * 100,
.groups = "drop"
) %>%
rename(NUTS2=geo)%>%
select(NUTS2, TIME_PERIOD, andelen_over65)
# Kobler sammen datasett
panel_df <- gdp_pop_panel %>%
left_join(edu_panel, by = c("NUTS2", "TIME_PERIOD")) %>%
left_join(pop_panel, by = c("NUTS2", "TIME_PERIOD"))
# Oppretter landkode fra NUTS2 og aggregerer data til land × år
panel_country <- panel_df %>%
mutate(country = substr(NUTS2, 1, 2)) %>%
group_by(country, TIME_PERIOD) %>%
summarise(
Gini_weighted   = mean(Gini_weighted,   na.rm = TRUE),
change_GDPC_pct = mean(change_GDPC_pct, na.rm = TRUE),
Høy_utdanning   = mean(Høy_utdanning,   na.rm = TRUE),
andelen_over65  = mean(andelen_over65,  na.rm = TRUE),
.groups = "drop"
)
panel_country <- pdata.frame(panel_country, index = c("country", "TIME_PERIOD"))
# Modell 1: land-faste effekter
fe_country <- plm(
Gini_weighted ~ change_GDPC_pct + Høy_utdanning + andelen_over65,
data   = panel_country,
model  = "within",
effect = "individual"
)
summary(fe_country)
# Konverterer datasettet til et panelobjekt med NUTS2 som enhets-ID og TIME_PERIOD som tidsvariabel
panel_df <- pdata.frame(panel_df, index = c("NUTS2", "TIME_PERIOD"))
# Modell 2: Faste effekter for år (year FE)
fe_year <- plm(
Gini_weighted ~ change_GDPC_pct + `Høy_utdanning` + andelen_over65,
data   = panel_df,   # pdata.frame med NUTS2 og år
model  = "within",
effect = "time"      # år som tids-FE
)
summary(fe_year)
# Modell 3: Faste effekter på NUTS2-nivå (region FE)
fe_region <- plm(
Gini_weighted ~ change_GDPC_pct + `Høy_utdanning` + andelen_over65,
data   = panel_df,
model  = "within",
effect = "individual"    # individual = NUTS2-FE siden panelet er indeksert etter NUTS2
)
summary(fe_region)
# Modell 3: Faste effekter på NUTS2-nivå (region FE)
fe_region <- plm(
Gini_weighted ~ change_GDPC_pct + Høy_utdanning + andelen_over65,
data   = panel_df,
model  = "within",
effect = "individual"    # individual = NUTS2-FE siden panelet er indeksert etter NUTS2
)
summary(fe_region)
# Modell 2: Faste effekter for år (year FE)
fe_year <- plm(
Gini_weighted ~ change_GDPC_pct + Høy_utdanning + andelen_over65,
data   = panel_df,   # pdata.frame med NUTS2 og år
model  = "within",
effect = "time"      # år som tids-FE
)
summary(fe_year)
# Modell 4: Toveis faste effekter (NUTS2 + år)
fe_twoway <- plm(
Gini_weighted ~ change_GDPC_pct + Høy_utdanning + andelen_over65,
data   = panel_df,
model  = "within",
effect = "twoways"  # kontrollerer både for NUTS2- og årsfaste effekter
)
summary(fe_twoway)
#| label: tbl-panel
#| tbl-cap: "Sammenligning av panelmodeller"
modelsummary(
list(
"Region FE"   = fe_region,
"Year FE"    = fe_year,
"Two-way FE" = fe_twoway,
"Country FE" = fe_country
),
stars = TRUE,
fmt = 5,
output = "markdown"
)
